<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>商品管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    .table td,
    .table th {
      vertical-align: middle;
    }
  </style>
</head>

<body x-data="adminAuth()" x-init="authCheck()">
  <template x-if="authorized">
    <div class="container" x-data="productAdmin()" x-init="loadJson()">
      <h2 class="my-4 text-center fs-3">商品管理(阿昌)</h2>
      <div class="mb-3 d-flex gap-2 flex-wrap">
        <button class="btn btn-info fs-3" @click="$refs.fileInput.click()">匯入商品名單</button>
        <input type="file" x-ref="fileInput" @change="importProducts" accept=".json" style="display:none;">
        <button class="btn btn-success fs-3" @click="uploadJson">儲存設定</button>
      </div>
      <div id="jsonMsg" x-text="msg" class="mb-2 fs-3"></div>
      <div id="tableArea">
        <template x-if="products.length">
          <table class="table table-bordered table-striped fs-3">
            <thead>
              <tr>
                <th class="fs-3">品名</th>
                <th class="fs-3">單價</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(item, idx) in products" :key="idx">
                <tr>
                  <td class="col-6">
                    <input type="text" class="form-control fs-2" x-model="item.product_name" readonly>
                  </td>
                  <td class="col">
                    <input type="number" class="form-control fs-3" x-model.number="item.price" min="0" step="1">
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </template>
        <template x-if="!products.length">
          <p class="fs-3">尚未載入商品</p>
        </template>
      </div>
    </div>
  </template>
  <template x-if="!authorized">
    <div class="container text-center mt-5">
      <h2 class="fs-2">請輸入管理密碼</h2>
      <input type="password" class="form-control fs-3 w-50 mx-auto my-3" x-model="password" @keyup.enter="authCheck()">
      <button class="btn btn-primary fs-3" @click="authCheck()">登入</button>
      <div class="text-danger mt-2 fs-4" x-text="errorMsg"></div>
    </div>
  </template>
  <script>
    function adminAuth() {
      return {
        authorized: false,
        password: '',
        errorMsg: '',
        async authCheck() {
          if (!this.password) return;
          try {
            const res = await fetch('/.netlify/functions/adminPassword', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password: this.password })
            });
            const result = await res.json();
            if (res.ok && result.success) {
              this.authorized = true;
              this.errorMsg = '';
            } else {
              this.errorMsg = '密碼錯誤';
            }
          } catch (e) {
            this.errorMsg = '伺服器錯誤';
          }
        }
      }
    }

    function productAdmin() {
      return {
        products: [],
        msg: '',
        async loadJson() {
          this.msg = '';
          try {
            const res = await fetch('/non_pickup.json');
            if (!res.ok) throw new Error('讀取失敗');
            this.products = await res.json();
            this.sortProducts();
          } catch (e) {
            this.msg = e.message;
          }
        },
        addProduct() {
          this.products.push({ product_name: '新商品', price: 0, product_group: 0 });
          this.sortProducts();
          this.$nextTick(() => {
            const inputs = document.querySelectorAll('input[type="text"]');
            if (inputs.length) inputs[inputs.length - 1].focus();
          });
        },
        sortProducts() {
          this.products.sort((a, b) => a.product_group - b.product_group);
        },
        importProducts(event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const newProducts = JSON.parse(e.target.result);
              // 建立舊商品的價格對照表 (key: product_name + product_group)
              const oldPriceMap = {};
              this.products.forEach(item => {
                const key = `${item.product_name}_${item.product_group}`;
                oldPriceMap[key] = item.price;
              });
              // 更新商品列表：保留舊價格，新商品使用匯入的價格
              this.products = newProducts.map(item => {
                const key = `${item.product_name}_${item.product_group}`;
                return {
                  ...item,
                  price: oldPriceMap[key] !== undefined ? oldPriceMap[key] : item.price
                };
              });
              this.sortProducts();
              this.msg = '匯入成功！已保留原有商品的價格';
              event.target.value = ''; // 清空檔案選擇器
            } catch (err) {
              this.msg = '匯入失敗：' + err.message;
            }
          };
          reader.readAsText(file);
        },
        deleteProduct(idx) {
          if (confirm('確定要刪除這個商品嗎？')) {
            this.products.splice(idx, 1);
            this.sortProducts();
          }
        },
        async uploadJson() {
          this.msg = '';
          try {
            const res = await fetch('/.netlify/functions/updateNonPickup', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.products)
            });
            const result = await res.json();
            if (result.success) {
              this.msg = '上傳成功！請等待約30秒後，變更才會生效!';
            } else {
              this.msg = '上傳失敗：' + (result.message || result.error || '未知錯誤');
            }
          } catch (e) {
            this.msg = '上傳失敗：' + e.message;
          }
        }
      };
    }
  </script>
</body>

</html>